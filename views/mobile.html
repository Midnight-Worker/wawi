<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Produktfoto zum Pi senden</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1>Produktfoto senden</h1>

    <label>EAN:
        <input id="ean" type="text" placeholder="EAN">
    </label>
    <br><br>

    <input id="fileInput" type="file" accept="image/*" capture="environment">
    <br><br>

    <button id="sendBtn">Bild senden</button>

    <pre id="log"></pre>

    <script>
        // Verwendet automatisch die IP des Servers, auf dem die Seite aufgerufen wird
        const wsUrl = "ws://" + window.location.hostname + ":8765";
        let ws;

        function log(msg) {
            document.getElementById("log").textContent += msg + "\n";
        }

        function connect() {
            ws = new WebSocket(wsUrl);
            ws.onopen = () => log("Verbunden mit " + wsUrl);
            ws.onmessage = (e) => log("Server: " + e.data);
            ws.onclose = () => log("Verbindung geschlossen.");
            ws.onerror = (e) => log("Fehler: " + e);
        }

        connect();

        document.getElementById("sendBtn").onclick = () => {
            const ean = document.getElementById("ean").value.trim();
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];

            if (!ean || !file) {
                log("Bitte EAN und Bild wÃ¤hlen.");
                return;
            }

            const reader = new FileReader();
            reader.onload = () => {
                const base64Data = reader.result.split(",")[1]; // 'data:image/...;base64,...'
                const payload = {
                    ean: ean,
                    image_base64: base64Data
                };

                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(payload));
                    log("Bild gesendet.");
                } else {
                    log("WebSocket nicht verbunden.");
                }
            };
            reader.readAsDataURL(file);
        };
    </script>
</body>
</html>
